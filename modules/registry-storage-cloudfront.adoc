// Module included in the following assemblies:
//
// * registry/configuring-registry-storage-aws-user-infrastructure.adoc

[id="registry-storage-cloudfront_{context}"]
= Configuring CloudFront middleware

The link:https://docs.docker.com/registry/configuration/#cloudfront[CloudFront
middleware extension] can be added to support AWS, CloudFront CDN storage
provider. CloudFront middleware speeds up distribution of image content
internationally. The blobs are distributed to several edge locations around the
world. The client is always directed to the edge with the lowest latency.

[NOTE]
====
The link:https://docs.docker.com/registry/configuration/#cloudfront[*CloudFront*
middleware extension] can be only used with
link:https://docs.docker.com/registry/storage-drivers/s3/[S3] storage.
It is used only during blob serving. Only blob downloads can be
sped up, not uploads.
====

The following is an example of minimal configuration of S3 storage driver with a
CloudFront middleware:

[source,yaml]
----
version: 0.1
log:
  level: debug
http:
  addr: :5000
storage:
  cache:
    blobdescriptor: inmemory
  delete:
    enabled: true
  s3: <1>
    accesskey: BJKMSZBRESWJQXRWMAEQ
    secretkey: 5ah5I91SNXbeoUXXDasFtadRqOdy62JzlnOW1goS
    region: us-east-1
    bucket: docker.myregistry.com
auth:
  openshift:
    realm: openshift
middleware:
  registry:
    - name: openshift
  repository:
    - name: openshift
  storage:
    - name: cloudfront <2>
      options:
        baseurl: https://jrpbyn0k5k88bi.cloudfront.net/ <3>
        privatekey: /etc/docker/cloudfront-ABCEDFGHIJKLMNOPQRST.pem <4>
        keypairid: ABCEDFGHIJKLMNOPQRST <5>
    - name: openshift
----
<1> The S3 storage must be configured the same way regardless of CloudFront
middleware.
<2> The CloudFront storage middleware needs to be listed before OpenShift
middleware.
<3> The CloudFront base URL. In the AWS management console, this is listed as
*Domain Name* of CloudFront distribution.
<4> The location of your AWS private key on the filesystem. This must be not
confused with Amazon EC2 key pair. See the
link:http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-trusted-signers.html#private-content-creating-cloudfront-key-pairs[AWS
documentation] on creating CloudFront key pairs for your trusted signers. The
file needs to be mounted as a secret into the registry
pod.
<5> The ID of your Cloudfront key pair.
